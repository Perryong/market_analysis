name: Market Data Analysis

on:
  workflow_dispatch:  # Allows manual triggering
  schedule:
    # Runs at 9:00 AM UTC (adjust timezone as needed)
    - cron: '30 2 * * *'
    # Runs at 10:30 PM UTC (adjust timezone as needed)
    - cron: '30 13 * * *'
  push:
    branches:
      - master
      - main
    paths:
      - main.py
      - 'analysis/**'
      - 'data/**'
      - 'technical/**'
      - 'config/**'
      - .github/workflows/run_market_data.yml

env:
  # Python version to use
  PYTHON_VERSION: '3.11'

jobs:
  analyze:
    name: Run Market Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for pushing commits

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create Directories
        run: |
          mkdir -p .cache/yfinance
          mkdir -p .cache/seeking_alpha
          mkdir -p results
          mkdir -p plots

      - name: Run Market Analysis
        run: |
          echo "Starting market data analysis..."
          python main.py
        env:
          # Add any environment variables your script might need
          PYTHONUNBUFFERED: 1

      - name: Commit and Push Results
        run: |
          git config --local user.email 'action@github.com'
          git config --local user.name 'GitHub Action'
          
          # Check if index.html exists and was generated
          if [ -f "index.html" ]; then
            echo "âœ… index.html found, checking if it needs to be updated..."
            git add index.html
          else
            echo "âš ï¸  index.html not found - it should be generated by main.py"
          fi
          
          # Add all results and plots (including traderXO)
          git add results/ plots/ traderXO/plots/
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update market analysis results and charts - $(date '+%Y-%m-%d %H:%M:%S UTC')"
            echo "âœ… Committed changes"
            
            # Push changes
            git push origin HEAD:${{ github.ref_name }} || echo "Push failed or no changes"
          fi

      - name: Upload Analysis Results as Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: market-analysis-results-${{ github.run_number }}
          path: |
            results/*.csv
            results/*.json
            plots/**/*.html
            plots/**/*.png
          retention-days: 30

      - name: Summary
        if: success()
        run: |
          echo "âœ… Market analysis completed successfully!"
          echo "ðŸ“Š Results saved to results/ directory"
          echo "ðŸ“ˆ Charts saved to plots/ directory"
          echo "ðŸ“… Analysis run at: $(date)"
          echo ""
          
          # Get current date in YYYY-MM-DD format
          CURRENT_DATE=$(date +%Y-%m-%d)
          echo "ðŸ“… Displaying results for: $CURRENT_DATE"
          echo ""
          
          echo "Results (Current Date Only):"
          if ls results/${CURRENT_DATE}_*.csv results/${CURRENT_DATE}_*.json 2>/dev/null; then
            ls -lh results/${CURRENT_DATE}_*.csv results/${CURRENT_DATE}_*.json 2>/dev/null | awk '{print $9, $5}'
          else
            echo "  No results found for $CURRENT_DATE"
          fi
          
          echo ""
          echo "Charts (Current Date Only):"
          if [ -d "plots/${CURRENT_DATE}" ]; then
            ls -lh plots/${CURRENT_DATE}/ 2>/dev/null | tail -n +2 | awk '{print $9, $5}'
          else
            echo "  No charts found for $CURRENT_DATE"
          fi

